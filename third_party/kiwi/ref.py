import os
import sys
from pathlib import Path
from pathlib import Path
import mitsuba as mi
import drjit as dr

def set_root_path():
    if os.getcwd().endswith('figures'): 
        os.chdir('../')

def update_light_position(params, sensor, index):
    light_positions = [
        ["-5.000000 0.000001 -0.000000 0.300000 0.000000 3.535533 3.535534 -8.142137 0.000001 3.535534 -3.535533 13.642134 0.000000 0.000000 0.000000 1.000000"],
        ["-5.000000 0.000001 -0.000000 0.300000 0.000001 3.535533 -3.535534 20.142136 -0.000000 -3.535534 -3.535533 13.642134 0.000000 0.000000 0.000000 1.000000"],
        ["-4.885884 0.593753 -0.880678 3.822712 0.000000 4.145782 2.795083 -5.180335 1.062138 2.731290 -4.051163 15.704649 0.000000 0.000000 0.000000 1.000000"],
        ["-4.885884 -0.880677 -0.593753 2.675009 0.000001 2.795083 -4.145782 22.583132 1.062137 -4.051163 -2.731290 10.425161 0.000000 0.000000 0.000000 1.000000"],
        ["-4.996456 -0.174787 0.069850 0.020601 0.000000 1.855465 4.642978 -12.571915 -0.188227 4.639687 -1.854150 6.916601 0.000000 0.000000 0.000000 1.000000"],
        ["-4.996456 0.069851 0.174787 -0.399148 0.000001 4.642978 -1.855466 13.421865 -0.188227 -1.854150 -4.639687 18.058748 0.000000 0.000000 0.000000 1.000000"],
        ["-4.744681 -0.607034 1.455854 -5.523414 -0.000000 4.614902 1.924233 -1.696932 -1.577340 1.825975 -4.379248 17.016994 0.000000 0.000000 0.000000 1.000000"],
        ["-4.744681 1.455854 0.607033 -2.128134 0.000000 1.924232 -4.614903 24.459614 -1.577339 -4.379249 -1.825973 6.803894 0.000000 0.000000 0.000000 1.000000"],
        ["-4.202836 2.089174 -1.723811 7.195245 0.000001 3.182182 3.856646 -9.426586 2.708537 3.241770 -2.674838 10.199351 0.000000 0.000000 0.000000 1.000000"],
        ["-4.202836 -1.723812 -2.089173 8.656693 0.000001 3.856645 -3.182184 18.728733 2.708536 -2.674840 -3.241769 12.467078 0.000000 0.000000 0.000000 1.000000"],
        ["-4.207933 -2.426503 1.185488 -4.441956 -0.000000 2.194853 4.492507 -11.970030 -2.700611 3.780834 -1.847159 6.888636 0.000000 0.000000 0.000000 1.000000"],
        ["-4.207933 1.185489 2.426502 -9.406012 0.000000 4.492507 -2.194854 14.779416 -2.700611 -1.847160 -3.780833 14.623335 0.000000 0.000000 0.000000 1.000000"],
        ["-4.877633 0.109548 -1.093937 4.675749 -0.000000 4.975117 0.498212 4.007148 1.099408 0.486019 -4.853358 18.913433 0.000000 0.000000 0.000000 1.000000"],
        ["-4.877633 -1.093937 -0.109548 0.738191 -0.000001 0.498215 -4.975116 25.900467 1.099408 -4.853358 -0.486023 1.444077 0.000000 0.000000 0.000000 1.000000"],
        ["-4.556884 2.044208 -0.236690 1.246759 0.000000 0.575086 4.966817 -13.867271 2.057864 4.526643 -0.524120 1.596480 0.000000 0.000000 0.000000 1.000000"],
        ["-4.556884 -0.236691 -2.044208 8.476832 -0.000000 4.966817 -0.575088 8.300348 2.057866 -0.524122 -4.526642 17.606571 0.000000 0.000000 0.000000 1.000000"],
        ["-3.481129 -1.811379 3.098490 -12.093963 0.000000 4.316512 2.523435 -4.093743 -3.589114 1.756881 -3.005267 11.521069 0.000000 0.000000 0.000000 1.000000"],
        ["-3.481130 3.098490 1.811379 -6.945517 0.000000 2.523435 -4.316512 23.266048 -3.589113 -3.005268 -1.756882 6.527522 0.000000 0.000000 0.000000 1.000000"],
        ["-3.311121 1.748085 -3.313711 13.554841 0.000001 4.422375 2.332939 -3.331758 3.746529 1.544928 -2.928604 11.214415 0.000000 0.000000 0.000000 1.000000"],
        ["-3.311121 -3.313711 -1.748084 7.292337 0.000000 2.332938 -4.422375 23.689499 3.746529 -2.928604 -1.544928 5.679714 0.000000 0.000000 0.000000 1.000000"],
        ["4.330296 2.498345 -0.082554 0.630227 -0.000002 0.165130 4.997272 -13.989090 2.499708 -4.327933 0.143013 -1.072060 0.000000 0.000000 0.000000 1.000000"],
        ["-4.330294 -0.082557 2.498348 -9.693389 -0.000001 4.997272 0.165132 5.339473 -2.499711 0.143014 -4.327931 16.811728 0.000000 0.000000 0.000000 1.000000"],
        ["-4.554053 0.279160 2.045158 -7.880636 -0.000000 4.954062 -0.676221 8.704880 -2.064123 -0.615909 -4.512212 17.548845 0.000000 0.000000 0.000000 1.000000"],
        ["4.554052 -2.045160 -0.279161 1.416643 -0.000000 0.676221 -4.954062 25.816246 2.064124 4.512211 0.615909 -2.963636 0.000000 0.000000 0.000000 1.000000"],
        ["-2.827435 3.888359 -1.373419 5.793676 0.000000 1.665240 4.714550 -12.858198 4.123786 2.666016 -0.941671 3.266687 0.000000 0.000000 0.000000 1.000000"],
        ["-2.827435 -1.373420 -3.888358 15.853435 -0.000001 4.714549 -1.665241 12.660967 4.123786 -0.941672 -2.666016 10.164063 0.000000 0.000000 0.000000 1.000000"],
        ["-2.390293 -3.637797 2.460271 -9.541087 -0.000001 2.801085 4.141729 -10.566917 -4.391640 1.979989 -1.339083 4.856333 0.000000 0.000000 0.000000 1.000000"],
        ["-2.390294 2.460273 3.637795 -14.251184 -0.000000 4.141728 -2.801087 17.204346 -4.391639 -1.339085 -1.979989 7.419957 0.000000 0.000000 0.000000 1.000000"],
        ["-3.181355 -0.178813 -3.853181 15.712726 -0.000000 4.994625 -0.231784 6.927135 3.857328 -0.147477 -3.177935 12.211742 0.000000 0.000000 0.000000 1.000000"],
        ["3.181352 3.853184 0.178814 -0.415258 -0.000002 0.231787 -4.994625 25.978500 -3.857330 3.177932 0.147481 -1.089913 0.000000 0.000000 0.000000 1.000000"],
        ["4.781842 -1.363049 0.525437 -1.801747 -0.000000 1.798435 4.665365 -12.661461 -1.460817 -4.461808 1.719966 -7.379862 0.000000 0.000000 0.000000 1.000000"],
        ["-4.781842 0.525436 -1.363049 5.752198 -0.000000 4.665366 1.798433 -1.193734 1.460817 1.719965 -4.461809 17.347233 0.000000 0.000000 0.000000 1.000000"],
        ["-2.177441 -0.611861 4.459190 -17.536764 0.000000 4.953586 0.679699 3.281204 -4.500972 0.296001 -2.157228 8.128909 0.000000 0.000000 0.000000 1.000000"],
        ["-2.177442 4.459190 0.611860 -2.147441 -0.000001 0.679697 -4.953586 25.814342 -4.500972 -2.157229 -0.296000 0.684001 0.000000 0.000000 0.000000 1.000000"],
        ["-1.531798 3.230546 -3.495307 14.281227 0.000000 3.671865 3.393730 -7.574924 4.759579 1.039702 -1.124911 3.999644 0.000000 0.000000 0.000000 1.000000"],
        ["-1.531799 -3.495307 -3.230545 13.222182 -0.000000 3.393730 -3.671866 20.687464 4.759579 -1.124911 -1.039702 3.658807 0.000000 0.000000 0.000000 1.000000"],
        ["-1.809440 -4.657831 0.174736 -0.398931 0.000005 0.187439 4.996485 -13.985943 -4.661108 1.808169 -0.067827 -0.228675 0.000000 0.000000 0.000000 1.000000"],
        ["-1.809439 0.174735 4.657832 -18.331331 0.000000 4.996485 -0.187439 6.749753 -4.661108 -0.067832 -1.808167 6.732666 0.000000 0.000000 0.000000 1.000000"],
        ["-4.902422 -0.517469 -0.835755 3.643019 -0.000001 4.251106 -2.632128 16.528511 0.982985 -2.580760 -4.168143 16.172573 0.000000 0.000000 0.000000 1.000000"],
        ["4.902422 0.835755 0.517469 -1.769875 -0.000000 2.632128 -4.251106 23.004423 -0.982985 4.168143 2.580761 -10.823042 0.000000 0.000000 0.000000 1.000000"],
        ["1.399851 -4.788344 0.334923 -1.039692 0.000001 0.348875 4.987814 -13.951258 -4.800044 -1.396440 0.097675 -0.890699 0.000000 0.000000 0.000000 1.000000"],
        ["-1.399854 0.334921 -4.788344 19.453375 -0.000000 4.987814 0.348873 4.604506 4.800043 0.097674 -1.396442 5.085769 0.000000 0.000000 0.000000 1.000000"],
        ["-0.720590 -3.006274 3.929766 -15.419065 0.000001 3.971224 3.037990 -6.151960 -4.947803 0.437830 -0.572325 1.789296 0.000000 0.000000 0.000000 1.000000"],
        ["-0.720589 3.929767 3.006274 -11.725097 0.000000 3.037989 -3.971224 21.884899 -4.947803 -0.572324 -0.437829 1.251313 0.000000 0.000000 0.000000 1.000000"],
        ["-0.619988 0.893811 -4.880237 19.820951 -0.000000 4.918193 0.900762 2.396950 4.961412 0.111693 -0.609844 1.939380 0.000000 0.000000 0.000000 1.000000"],
        ["-0.619988 -4.880238 -0.893810 3.875239 -0.000001 0.900762 -4.918193 25.672777 4.961412 -0.609844 -0.111693 -0.053231 0.000000 0.000000 0.000000 1.000000"],
        ["1.345806 4.090324 -2.541269 10.465077 0.000000 2.638648 4.247062 -10.988247 4.815475 -1.143145 0.710222 -3.340885 0.000000 0.000000 0.000000 1.000000"],
        ["-1.345806 -2.541268 4.090325 -16.061302 -0.000001 4.247063 2.638647 -4.554589 -4.815475 0.710220 -1.143145 4.072576 0.000000 0.000000 0.000000 1.000000"],
        ["-0.205110 1.306940 4.821809 -18.987236 0.000000 4.825871 -1.308041 11.232165 -4.995791 -0.053658 -0.197967 0.291863 0.000000 0.000000 0.000000 1.000000"],
        ["0.205108 -4.821808 -1.306942 5.527766 0.000000 1.308043 -4.825871 25.303484 4.995791 0.197965 0.053658 -0.714633 0.000000 0.000000 0.000000 1.000000"],
        ["0.107106 4.441679 -2.293473 9.473894 -0.000000 2.294000 4.442698 -11.770794 4.998853 -0.095168 0.049141 -0.696560 0.000000 0.000000 0.000000 1.000000"],
        ["0.107105 -2.293475 -4.441678 18.066713 -0.000001 4.442697 -2.294001 15.176004 4.998853 0.049140 0.095166 -0.880670 0.000000 0.000000 0.000000 1.000000"],
        ["0.337081 -4.680239 1.726771 -6.607086 0.000001 1.730709 4.690911 -12.763645 -4.988625 -0.316243 0.116678 -0.966713 0.000000 0.000000 0.000000 1.000000"],
        ["0.337082 1.726773 4.680238 -18.420956 0.000001 4.690910 -1.730710 12.922840 -4.988625 0.116679 0.316244 -1.764977 0.000000 0.000000 0.000000 1.000000"],
        ["1.283949 -1.777810 -4.493424 18.273699 -0.000000 4.649329 -1.839494 13.357971 4.832336 0.472363 1.193900 -5.275603 0.000000 0.000000 0.000000 1.000000"],
        ["-1.283951 4.493424 1.777810 -6.811242 -0.000000 1.839494 -4.649330 24.597319 -4.832335 -1.193903 -0.472364 1.389454 0.000000 0.000000 0.000000 1.000000"],
        ["-1.961403 -4.213163 1.844492 -7.077966 -0.000000 2.005219 4.580295 -12.321178 -4.599228 1.796761 -0.786609 2.646435 0.000000 0.000000 0.000000 1.000000"],
        ["1.961403 1.844491 -4.213164 17.152655 0.000000 4.580295 2.005217 -2.020872 4.599228 -0.786608 1.796761 -7.687044 0.000000 0.000000 0.000000 1.000000"],
        ["1.032681 -1.494380 4.658369 -18.333477 0.000000 4.761022 1.527310 -0.109240 -4.892195 -0.315444 0.983323 -4.433292 0.000000 0.000000 0.000000 1.000000"],
        ["1.032680 4.658370 1.494378 -5.677514 0.000000 1.527308 -4.761022 25.044086 -4.892195 0.983322 0.315444 -1.761778 0.000000 0.000000 0.000000 1.000000"],
        ["1.158763 2.477234 -4.185759 17.043037 -0.000000 4.302907 2.546565 -4.186259 4.863873 -0.590173 0.997210 -4.488839 0.000000 0.000000 0.000000 1.000000"],
        ["1.158761 -4.185760 -2.477232 10.208932 0.000001 2.546563 -4.302908 23.211632 4.863874 0.997208 0.590172 -2.860690 0.000000 0.000000 0.000000 1.000000"],
        ["-2.267311 4.399148 -0.711895 3.147579 -0.000001 0.798737 4.935790 -13.743158 4.456378 2.238194 -0.362197 0.948788 0.000000 0.000000 0.000000 1.000000"],
        ["2.267311 -0.711893 4.399148 -17.296593 -0.000000 4.935790 0.798735 2.805055 -4.456378 -0.362197 2.238194 -9.452779 0.000000 0.000000 0.000000 1.000000"],
        ["4.423830 0.975832 2.116005 -8.164021 0.000000 4.540438 -2.093901 14.375603 -2.330177 1.852613 4.017225 -16.568903 0.000000 0.000000 0.000000 1.000000"],
        ["-4.423830 -2.116006 -0.975832 4.203331 -0.000000 2.093901 -4.540438 24.161753 2.330178 -4.017225 -1.852613 6.910453 0.000000 0.000000 0.000000 1.000000"],
        ["2.118931 4.460674 -0.782633 3.430533 -0.000001 0.864060 4.924774 -13.699097 4.528811 -2.087051 0.366177 -1.964707 0.000000 0.000000 0.000000 1.000000"],
        ["2.118930 -0.782635 -4.460675 18.142698 0.000001 4.924774 -0.864062 9.456245 4.528812 0.366177 2.087050 -8.848203 0.000000 0.000000 0.000000 1.000000"],
        ["1.944414 -3.495689 2.999902 -11.699605 -0.000000 3.256207 3.794353 -9.177413 -4.606436 -1.475559 1.266283 -5.565133 0.000000 0.000000 0.000000 1.000000"],
        ["1.944414 2.999903 3.495688 -13.682755 0.000000 3.794353 -3.256208 19.024828 -4.606436 1.266284 1.475558 -6.402237 0.000000 0.000000 0.000000 1.000000"],
        ["2.863202 0.246888 -4.091591 16.666363 -0.000000 4.990922 0.301153 4.795383 4.099033 -0.172453 2.858004 -11.932019 0.000000 0.000000 0.000000 1.000000"],
        ["2.863203 -4.091591 -0.246887 1.287550 -0.000001 0.301152 -4.990922 25.963690 4.099032 2.858005 0.172451 -1.189811 0.000000 0.000000 0.000000 1.000000"],
        ["-4.999790 0.043877 -0.013418 0.353671 0.000000 1.462205 4.781418 -13.125671 0.045883 4.781217 -1.462144 5.348577 0.000000 0.000000 0.000000 1.000000"],
        ["4.999790 -0.013418 0.043876 0.124495 0.000000 4.781418 1.462205 0.151180 -0.045882 -1.462143 4.781217 -19.624866 0.000000 0.000000 0.000000 1.000000"],
        ["3.309312 -0.354768 3.731299 -14.625196 0.000000 4.977552 0.473260 4.106959 -3.748127 -0.313233 3.294455 -13.677820 0.000000 0.000000 0.000000 1.000000"],
        ["3.309314 3.731297 0.354767 -1.119068 0.000001 0.473258 -4.977552 25.910210 -3.748125 3.294457 0.313231 -1.752931 0.000000 0.000000 0.000000 1.000000"],
        ["2.763308 3.164698 -2.710870 11.143479 0.000000 3.252761 3.797307 -9.189232 4.167029 -2.098626 1.797676 -7.690705 0.000000 0.000000 0.000000 1.000000"],
        ["2.763308 -2.710870 -3.164698 12.958792 -0.000000 3.797307 -3.252762 19.011047 4.167029 1.797677 2.098625 -8.894505 0.000000 0.000000 0.000000 1.000000"],
        ["3.388784 -3.536898 1.003243 -3.712976 0.000001 1.364426 4.810233 -13.240932 -3.676431 -3.260168 0.924749 -4.198997 0.000000 0.000000 0.000000 1.000000"],
        ["3.388784 1.003245 3.536897 -13.847590 0.000001 4.810233 -1.364428 11.457710 -3.676431 0.924751 3.260168 -13.540672 0.000000 0.000000 0.000000 1.000000"],
        ["4.884148 -0.086465 -1.066594 4.566377 -0.000000 4.983651 -0.404006 7.616024 1.070093 0.394645 4.868178 -19.972712 0.000000 0.000000 0.000000 1.000000"],
        ["-4.884148 1.066595 0.086466 -0.045860 -0.000001 0.404006 -4.983651 25.934605 -1.070094 -4.868178 -0.394644 1.078584 0.000000 0.000000 0.000000 1.000000"],
        ["4.316513 2.508336 -0.275613 1.402458 -0.000001 0.546109 4.970087 -13.880348 2.523433 -4.290689 0.471457 -2.385834 0.000000 0.000000 0.000000 1.000000"],
        ["4.316513 -0.275615 -2.508336 10.333345 -0.000000 4.970087 -0.546111 8.184443 2.523433 0.471459 4.290689 -17.662756 0.000000 0.000000 0.000000 1.000000"],
        ["3.634146 -1.937182 2.835544 -11.042177 -0.000000 4.128522 2.820516 -5.282064 -3.434092 -2.050033 3.000730 -12.502920 0.000000 0.000000 0.000000 1.000000"],
        ["3.634146 2.835545 1.937181 -7.448725 -0.000000 2.820514 -4.128522 22.514090 -3.434091 3.000731 2.050032 -8.700130 0.000000 0.000000 0.000000 1.000000"],
        ["3.956940 1.415270 -2.709176 11.136705 -0.000000 4.431725 2.315128 -3.260511 3.056571 -1.832164 3.507214 -14.528856 0.000000 0.000000 0.000000 1.000000"],
        ["3.956940 -2.709177 -1.415270 5.961079 -0.000000 2.315126 -4.431725 23.726902 3.056571 3.507214 1.832163 -7.828655 0.000000 0.000000 0.000000 1.000000"],
        ["4.833880 -1.257073 0.231023 -0.624093 0.000000 0.903758 4.917644 -13.670576 -1.278125 -4.754260 0.873731 -3.994930 0.000000 0.000000 0.000000 1.000000"],
        ["4.833880 0.231024 1.257072 -4.728291 -0.000000 4.917644 -0.903760 9.615040 -1.278125 0.873733 4.754260 -19.517040 0.000000 0.000000 0.000000 1.000000"],
        ["4.854392 -0.300387 1.159589 -4.338357 0.000000 4.840235 1.253842 0.984632 -1.197865 -1.217328 4.699280 -19.297121 0.000000 0.000000 0.000000 1.000000"],
        ["4.854392 1.159589 0.300386 -0.901545 -0.000000 1.253842 -4.840236 25.360945 -1.197865 4.699280 1.217328 -5.369308 0.000000 0.000000 0.000000 1.000000"],
        ["4.483294 1.853319 -1.210488 5.141954 -0.000000 2.734194 4.186190 -10.744761 2.213611 -3.753584 2.451639 -10.306556 0.000000 0.000000 0.000000 1.000000"],
        ["4.483294 -1.210489 -1.853319 7.713278 -0.000000 4.186190 -2.734194 16.936779 2.213611 2.451639 3.753583 -15.514335 0.000000 0.000000 0.000000 1.000000"],
        ["4.623368 -1.493966 1.180056 -4.420221 -0.000000 3.099207 3.923636 -9.694546 -1.903803 -3.628083 2.865755 -11.963018 0.000000 0.000000 0.000000 1.000000"],
        ["4.623368 1.180056 1.493966 -5.675862 0.000000 3.923635 -3.099207 18.396828 -1.903803 2.865756 3.628082 -15.012331 0.000000 0.000000 0.000000 1.000000"],
        ["4.945357 0.378341 -0.632693 2.830770 -0.000000 4.291272 2.566122 -4.264490 0.737185 -2.538078 4.244375 -17.477501 0.000000 0.000000 0.000000 1.000000"],
        ["4.945357 -0.632693 -0.378341 1.813366 -0.000000 2.566121 -4.291273 23.165091 0.737185 4.244376 2.538077 -10.652312 0.000000 0.000000 0.000000 1.000000"],
        ["5.000000 0.000000 0.000000 0.300000 0.000000 3.535533 3.535534 -8.142137 0.000000 -3.535534 3.535533 -14.642134 0.000000 0.000000 0.000000 1.000000"],
        ["5.000000 0.000000 0.000000 0.300000 0.000000 3.535533 -3.535535 20.142136 0.000000 3.535535 3.535533 -14.642134 0.000000 0.000000 0.000000 1.000000"],
    ]
    idx = int(sensor.id()[len('elm__') :])
    raw_string = light_positions[int((idx - 1) / 2) * 2 + index][0]
    float_values = list(map(float, raw_string.strip().split()))
    matrix_4x4 = np.array(float_values).reshape((4, 4))
    params['arealight.to_world'] = mi.Transform4f(matrix_4x4)
    params.update()

def save_images(scene, params, dir, spp):
    print("start rendering")
    for i, sensor in enumerate(scene.sensors()):
      for j in range(2):
        update_light_position(params, sensor, j)
        image = mi.render(scene, sensor=sensor, spp=spp)
        bitmap = mi.Bitmap(image).convert(
            pixel_format=mi.Bitmap.PixelFormat.RGB,
            component_format=mi.Struct.Type.UInt8,
            srgb_gamma=True
        )
        png_path = dir / f"view_{i:02d}_{j:02d}.png"
        bitmap.write(str(png_path))

        bitmap = mi.Bitmap(image).convert(
                pixel_format=mi.Bitmap.PixelFormat.RGB,
                component_format=mi.Struct.Type.Float32,
                srgb_gamma=False
        )
        exr_path = dir / f"view_{i:02d}_{j:02d}.exr"
        bitmap.write(str(exr_path))
        print(f"saving: {i}")
    print(f"Saved: {dir}")

def optimize(scene, params, opt, ref_images, spp):
   for it in range(iteration_count):
    total_loss = 0.0
    for i, sensor in enumerate(scene.sensors()):
        for j in range(2):
            update_light_position(params, sensor, j)
            img = mi.render(scene, params, sensor=sensor, spp=spp, seed=it)
            loss = dr.mean(dr.sqr(img - ref_images[i*2+j]))
            dr.backward(loss)
            opt.step()
            opt[key1] = dr.clip(opt[key1], 1e-6, 100.0)
            opt[key2] = dr.clip(opt[key2], 1e-6, 100.0)
            params.update(opt)
            total_loss += loss
            print(f"Sensor {i:02d} Light {j}: error={dr.mean(loss)}")
    print(f"Iteration {it:02d}: error={dr.mean(total_loss)}")

ref_spp=1024
opt_spp=128

key1="medium1.sigma_t.data"
key2="medium1.albedo.data"

set_root_path()
sys.path.append('python/')
sys.path = [p for p in sys.path if "unbiased-inverse-volume-rendering" not in p]
print(os.getcwd())
print(sys.executable)
os.environ.pop("PYTHONPATH")

# from practical_reconstruction import scene_configuration
mi.set_variant('cuda_ad_rgb')

# from practical_reconstruction import optimization_cli
# from core import integrators
# from core import bsdfs
# from core import textures
# from practical_reconstruction import scene_preparation

# integrators.register()
# bsdfs.register()
# textures.register()

import numpy as np

ref_scene_path="third_party/kiwi/mts_scene/kiwi_ref.xml"
ref_dir=Path("third_party/kiwi/references")

ref_scene = mi.load_file(ref_scene_path)
ref_params = mi.traverse(ref_scene)
#print(ref_scene)
save_images(ref_scene, ref_params, ref_dir, ref_spp)

init_scene_path="third_party/kiwi/mts_scene/kiwi_init.xml"
init_scene = mi.load_file(init_scene_path)

ref_images=[]
for i, sensor in enumerate(init_scene.sensors()):
    for j in range(2):
        exr_path = ref_dir / f"view_{i:02d}_{j:02d}.exr"
        bmp = mi.Bitmap(str(exr_path))
        tensor = mi.TensorXf(bmp)
        ref_image = mi.Bitmap(tensor)
        ref_images.append(tensor)

params = mi.traverse(init_scene)

opt = mi.ad.Adam(lr=0.02)
opt[key1] = params[key1]
opt[key2] = params[key2]
params.update(opt)
iteration_count = 1
optimize(init_scene, params, opt, ref_images, opt_spp)

opt[key1] = dr.upsample(opt[key1], shape=(74, 60, 64))
opt[key2] = dr.upsample(opt[key2], shape=(34, 18, 18))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)

opt[key1] = dr.upsample(opt[key1], shape=(148, 120, 128))
opt[key2] = dr.upsample(opt[key2], shape=(68, 36, 36))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
save_images(init_scene, params, Path("third_party/kiwi/intermediate"), ref_spp)

opt[key1] = dr.upsample(opt[key1], shape=(296, 240, 256))
opt[key2] = dr.upsample(opt[key2], shape=(136, 72, 72))
params.update(opt)
optimize(init_scene, params, opt, ref_images, ref_spp)
save_images(init_scene, params, Path("third_party/kiwi/intermediate2"), ref_spp)

opt[key1] = dr.upsample(opt[key1], shape=(592, 480, 512))
opt[key2] = dr.upsample(opt[key2], shape=(272, 144, 144))
params.update(opt)
optimize(init_scene, params, opt, ref_images, ref_spp)

sigma_t = opt[key1]
albedo = opt[key2]
grid_sigma_t = mi.VolumeGrid(sigma_t)
grid_sigma_t.write('third_party/kiwi/output/sigma_t.vol')
grid_albedo = mi.VolumeGrid(albedo)
grid_albedo.write('third_party/kiwi/output/albedo.vol')
save_images(init_scene, params, Path("third_party/kiwi/output"), ref_spp)