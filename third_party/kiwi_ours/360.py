import os
import sys
from pathlib import Path
from pathlib import Path
import mitsuba as mi
import drjit as dr

def set_root_path():
    if os.getcwd().endswith('figures'): 
        os.chdir('../')

def update_light_position(params, sensor, index):
    light_positions = [
        ["-6.500000 0.000001 0.000000 0.300000 0.000001 8.965753 0.043578 4.256886 -0.000001 0.784401 -0.498097 19.423895 0.000000 0.000000 0.000000 1.000000"],
        ["-6.500000 0.000001 -0.000000 0.300000 0.000001 8.965752 -0.043578 7.743114 -0.000000 -0.784403 -0.498097 19.423895 0.000000 0.000000 0.000000 1.000000"],
        ["-6.351649 -0.200248 -0.105630 4.525181 -0.000001 8.950497 -0.052370 8.094799 1.380779 -0.921145 -0.485901 18.936043 0.000000 0.000000 0.000000 1.000000"],
        ["-6.351649 -0.527366 -0.102093 4.383719 0.000001 8.650827 -0.137921 11.516834 1.380779 -2.425914 -0.469633 18.285309 0.000000 0.000000 0.000000 1.000000"],
        ["-6.495393 -0.160192 0.016586 -0.363436 0.000000 7.930473 0.236406 -3.456229 -0.244695 4.252285 -0.440270 17.110783 0.000000 0.000000 0.000000 1.000000"],
        ["-6.495393 -0.105917 0.017879 -0.415173 0.000000 8.548916 0.156308 -0.252319 -0.244695 2.811549 -0.474603 18.484127 0.000000 0.000000 0.000000 1.000000"],
        ["-6.168086 0.847423 0.150544 -5.721768 0.000001 8.589768 -0.149236 11.969419 -2.050541 -2.549069 -0.452841 17.613653 0.000000 0.000000 0.000000 1.000000"],
        ["-6.168086 1.305097 0.140082 -5.303277 -0.000001 7.992811 -0.229835 15.193392 -2.050540 -3.925774 -0.421370 16.354818 0.000000 0.000000 0.000000 1.000000"],
        ["-5.463686 0.886239 -0.266341 10.953645 0.000001 8.850055 0.090889 2.364422 3.521098 1.375175 -0.413281 16.031258 0.000000 0.000000 0.000000 1.000000"],
        ["-5.463686 0.040281 -0.270844 11.133778 0.000000 8.999693 0.004131 5.834756 3.521098 0.062503 -0.420269 16.310770 0.000000 0.000000 0.000000 1.000000"],
        ["-5.470313 -1.974225 0.246786 -9.571454 -0.000000 8.224349 0.203064 -2.122541 -3.510794 3.076120 -0.384528 14.881118 0.000000 0.000000 0.000000 1.000000"],
        ["-5.470313 -1.172859 0.262083 -10.183308 -0.000000 8.734113 0.120637 1.174509 -3.510794 1.827479 -0.408362 15.834473 0.000000 0.000000 0.000000 1.000000"],
        ["-6.340923 -1.114652 -0.090842 3.933682 -0.000001 7.436530 -0.281629 17.265163 1.429231 -4.945257 -0.403030 15.621183 0.000000 0.000000 0.000000 1.000000"],
        ["-6.340923 -1.381659 -0.078709 3.448351 -0.000001 6.443275 -0.349091 19.963663 1.429231 -6.129864 -0.349199 13.467967 0.000000 0.000000 0.000000 1.000000"],
        ["-5.923949 2.544862 -0.149531 6.281228 0.000000 6.539672 0.343514 -7.740579 2.675224 5.635278 -0.331117 12.744678 0.000000 0.000000 0.000000 1.000000"],
        ["-5.923949 2.038818 -0.171810 7.172383 0.000000 7.514031 0.275207 -5.008269 2.675225 4.514705 -0.380451 14.718030 0.000000 0.000000 0.000000 1.000000"],
        ["-4.525468 1.087335 0.353791 -13.851655 0.000001 8.871611 -0.084154 9.366148 -4.665848 -1.054619 -0.343147 13.225879 0.000000 0.000000 0.000000 1.000000"],
        ["-4.525468 2.176649 0.337927 -13.217074 0.000001 8.473795 -0.168461 12.738428 -4.665848 -2.111159 -0.327760 12.610391 0.000000 0.000000 0.000000 1.000000"],
        ["-4.304458 -1.423624 -0.366210 14.948386 -0.000001 8.797175 -0.105551 10.222051 4.870486 -1.258174 -0.323650 12.446008 0.000000 0.000000 0.000000 1.000000"],
        ["-4.304458 -2.546643 -0.346912 14.176490 -0.000000 8.333609 -0.188815 13.552604 4.870486 -2.250682 -0.306595 11.763819 0.000000 0.000000 0.000000 1.000000"],
        ["-5.629382 -3.540441 0.154266 -5.870659 -0.000000 5.554235 0.393428 -9.737112 -3.249624 6.133168 -0.267239 10.189544 0.000000 0.000000 0.000000 1.000000"],
        ["-5.629383 -3.004466 0.186078 -7.143115 0.000001 6.699578 0.333868 -7.354734 -3.249623 5.204694 -0.322346 12.393842 0.000000 0.000000 0.000000 1.000000"],
        ["-5.920269 2.751213 0.138724 -5.248968 -0.000001 6.048656 -0.370242 20.809698 -2.683361 -6.069973 -0.306066 11.742624 0.000000 0.000000 0.000000 1.000000"],
        ["-5.920268 3.143022 0.110075 -4.103014 -0.000001 4.799510 -0.422970 22.918791 -2.683361 -6.934415 -0.242858 9.214321 0.000000 0.000000 0.000000 1.000000"],
        ["-3.675667 3.772508 -0.355149 14.505958 -0.000000 7.750984 0.254116 -4.164632 5.360921 2.586586 -0.243505 9.240179 0.000000 0.000000 0.000000 1.000000"],
        ["-3.675665 2.605118 -0.386147 15.745892 -0.000000 8.427511 0.175480 -1.019221 5.360922 1.786175 -0.264758 10.090327 0.000000 0.000000 0.000000 1.000000"],
        ["-3.107381 -2.169506 0.422301 -16.592033 -0.000000 8.654415 0.137224 0.511019 -5.709132 1.180824 -0.229851 8.694041 0.000000 0.000000 0.000000 1.000000"],
        ["-3.107381 -0.816575 0.436815 -17.172585 -0.000002 8.951853 0.051650 3.934016 -5.709132 0.444445 -0.237751 9.010025 0.000000 0.000000 0.000000 1.000000"],
        ["-4.135763 -4.704761 -0.283677 11.647075 0.000000 6.618809 -0.338804 19.552162 5.014525 -3.880283 -0.233964 8.858571 0.000000 0.000000 0.000000 1.000000"],
        ["-4.135761 -5.519965 -0.233980 9.659192 0.000001 5.459266 -0.397509 21.900372 5.014527 -4.552626 -0.192976 7.219052 0.000000 0.000000 0.000000 1.000000"],
        ["-6.216394 2.487421 -0.047364 2.194574 -0.000000 2.918088 0.472989 -12.919552 1.899062 8.142327 -0.155043 5.701702 0.000000 0.000000 0.000000 1.000000"],
        ["-6.216394 2.301586 -0.070641 3.125649 0.000000 4.352160 0.437652 -11.506077 1.899062 7.534016 -0.231237 8.749484 0.000000 0.000000 0.000000 1.000000"],
        ["-2.830673 4.315680 0.380923 -14.936939 0.000001 7.616823 -0.266342 16.653698 -5.851264 -2.087801 -0.184280 6.871190 0.000000 0.000000 0.000000 1.000000"],
        ["-2.830673 5.440754 0.333502 -13.040101 -0.000001 6.668608 -0.335777 19.431061 -5.851264 -2.632082 -0.161339 5.953554 0.000000 0.000000 0.000000 1.000000"],
        ["-1.991337 0.410402 -0.475412 19.316462 -0.000000 8.989668 0.023952 5.041926 6.187453 0.132082 -0.153004 5.620157 0.000000 0.000000 0.000000 1.000000"],
        ["-1.991337 -1.081811 -0.472148 19.185926 0.000000 8.927959 -0.063136 8.525457 6.187453 -0.348165 -0.151954 5.578147 0.000000 0.000000 0.000000 1.000000"],
        ["-2.352270 -6.220423 0.312785 -12.211402 0.000000 6.039475 0.370705 -8.828190 -6.059441 2.414763 -0.121423 4.356915 0.000000 0.000000 0.000000 1.000000"],
        ["-2.352270 -5.148258 0.368042 -14.421692 0.000001 7.106422 0.306809 -6.272375 -6.059441 1.998550 -0.142874 5.214948 0.000000 0.000000 0.000000 1.000000"],
        ["-6.373148 -1.680510 -0.030760 1.530412 0.000001 2.816344 -0.474889 24.995544 1.277881 -8.381175 -0.153410 5.636408 0.000000 0.000000 0.000000 1.000000"],
        ["-6.373148 -1.751127 -0.014081 0.863236 -0.000001 1.289218 -0.494844 25.793743 1.277881 -8.733355 -0.070225 2.309015 0.000000 0.000000 0.000000 1.000000"],
        ["-1.819812 6.990062 -0.282132 11.585292 0.000001 5.289933 0.404514 -10.180557 6.240055 2.038539 -0.082279 2.791171 0.000000 0.000000 0.000000 1.000000"],
        ["-1.819809 6.002016 -0.345280 14.111202 -0.000000 6.473944 0.347336 -7.893433 6.240056 1.750389 -0.100695 3.527811 0.000000 0.000000 0.000000 1.000000"],
        ["-0.936765 0.401519 0.494277 -19.471090 -0.000001 8.990849 -0.022542 6.901674 -6.432144 -0.058478 -0.071986 2.379426 0.000000 0.000000 0.000000 1.000000"],
        ["-0.936768 1.940365 0.482894 -19.015783 0.000000 8.783799 -0.108935 10.357409 -6.432143 -0.282592 -0.070328 2.313116 0.000000 0.000000 0.000000 1.000000"],
        ["-0.805986 -4.414064 -0.431301 17.552036 -0.000000 7.823796 -0.247133 15.885323 6.449836 -0.551591 -0.053896 1.655852 0.000000 0.000000 0.000000 1.000000"],
        ["-0.805986 -5.695107 -0.382165 15.586620 0.000000 6.932480 -0.318856 18.754227 6.449836 -0.711674 -0.047756 1.410249 0.000000 0.000000 0.000000 1.000000"],
        ["-1.749547 -8.580360 0.068249 -2.429942 0.000000 1.275548 0.494953 -13.798115 -6.260118 2.397997 -0.019074 0.262951 0.000000 0.000000 0.000000 1.000000"],
        ["-1.749547 -8.236683 0.149987 -5.699498 0.000001 2.803227 0.475128 -13.005123 -6.260118 2.301949 -0.041918 1.176710 0.000000 0.000000 0.000000 1.000000"],
        ["-0.266642 7.381032 0.285363 -11.114536 -0.000000 5.140868 -0.410403 22.416113 -6.494529 -0.303040 -0.011716 -0.031361 0.000000 0.000000 0.000000 1.000000"],
        ["-0.266642 8.160849 0.209822 -8.092896 -0.000000 3.779985 -0.453762 24.150499 -6.494529 -0.335056 -0.008615 -0.155419 0.000000 0.000000 0.000000 1.000000"],
        ["0.139237 3.470950 -0.461196 18.747837 0.000000 8.303432 0.192875 -1.714996 6.498508 -0.074369 0.009882 -0.895264 0.000000 0.000000 0.000000 1.000000"],
        ["0.139237 1.976675 -0.487674 19.806959 -0.000000 8.780146 0.109841 1.606380 6.498508 -0.042352 0.010449 -0.917957 0.000000 0.000000 0.000000 1.000000"],
        ["0.438206 -4.455582 0.433118 -17.024734 0.000001 7.813907 0.248097 -3.923871 -6.485212 -0.301063 0.029266 -1.670635 0.000000 0.000000 0.000000 1.000000"],
        ["0.438206 -3.034108 0.469522 -18.480875 0.000001 8.470664 0.168946 -0.757837 -6.485212 -0.205014 0.031726 -1.769026 0.000000 0.000000 0.000000 1.000000"],
        ["1.669134 -7.650359 -0.229941 9.497636 0.000000 4.282541 -0.439766 23.590660 6.282037 2.032696 0.061095 -2.943807 0.000000 0.000000 0.000000 1.000000"],
        ["1.669133 -8.252851 -0.152644 6.405746 -0.000001 2.842915 -0.474400 24.975986 6.282038 2.192778 0.040557 -2.122293 0.000000 0.000000 0.000000 1.000000"],
        ["2.549824 7.943557 -0.129521 5.480829 -0.000001 2.534526 0.479764 -13.190556 5.978996 -3.387637 0.055236 -2.709435 0.000000 0.000000 0.000000 1.000000"],
        ["2.549825 7.418037 -0.204185 8.467418 -0.000000 3.995603 0.448024 -11.920975 5.978996 -3.163524 0.087078 -3.983106 0.000000 0.000000 0.000000 1.000000"],
        ["1.342485 3.329247 0.452909 -17.816345 0.000000 8.332001 -0.189034 13.561356 -6.359853 0.702762 0.095603 -4.324132 0.000000 0.000000 0.000000 1.000000"],
        ["1.342485 4.694309 0.413910 -16.256413 -0.000000 7.614563 -0.266542 16.661674 -6.359853 0.990909 0.087371 -3.994850 0.000000 0.000000 0.000000 1.000000"],
        ["1.506390 -1.427191 -0.479881 19.495253 0.000001 8.879612 -0.081507 9.260298 6.323036 0.340011 0.114326 -5.073051 0.000000 0.000000 0.000000 1.000000"],
        ["1.506392 -2.905458 -0.458823 18.652903 0.000001 8.489946 -0.165932 12.637274 6.323036 0.692191 0.109309 -4.872371 0.000000 0.000000 0.000000 1.000000"],
        ["2.947506 -6.889571 0.228237 -8.829502 0.000000 4.609434 0.429445 -11.177811 -5.793290 -3.505271 0.116123 -5.144900 0.000000 0.000000 0.000000 1.000000"],
        ["2.947505 -6.071509 0.291235 -11.349385 -0.000001 5.881710 0.378453 -9.138130 -5.793291 -3.089057 0.148174 -6.426963 0.000000 0.000000 0.000000 1.000000"],
        ["5.750979 3.793811 0.099370 -3.674804 0.000000 3.838038 -0.452256 24.090235 -3.029231 7.202532 0.188654 -8.046147 0.000000 0.000000 0.000000 1.000000"],
        ["5.750979 4.046772 0.061261 -2.150444 -0.000001 2.366131 -0.482411 25.296446 -3.029230 7.682777 0.116304 -5.152157 0.000000 0.000000 0.000000 1.000000"],
        ["2.754609 5.245214 -0.346680 14.167196 0.000000 6.889487 0.321719 -6.868753 5.887455 -2.454118 0.162204 -6.988153 0.000000 0.000000 0.000000 1.000000"],
        ["2.754609 4.081922 -0.392014 15.980571 -0.000001 7.790406 0.250367 -4.014700 5.887455 -1.909839 0.183415 -7.836591 0.000000 0.000000 0.000000 1.000000"],
        ["2.527739 -1.349196 0.454504 -17.880175 0.000001 8.880053 0.081359 2.745625 -5.988367 -0.569506 0.191850 -8.174003 0.000000 0.000000 0.000000 1.000000"],
        ["2.527740 0.091930 0.460615 -18.124611 0.000001 8.999447 -0.005544 6.221743 -5.988366 0.038806 0.194430 -8.277182 0.000000 0.000000 0.000000 1.000000"],
        ["3.722162 -4.393617 -0.329304 13.472149 -0.000000 7.230322 -0.297741 17.909624 5.328743 3.068970 0.230021 -9.700837 0.000000 0.000000 0.000000 1.000000"],
        ["3.722163 -5.356161 -0.281915 11.576605 -0.000001 6.189839 -0.362969 20.518763 5.328743 3.741315 0.196920 -8.376787 0.000000 0.000000 0.000000 1.000000"],
        ["6.499726 -0.076025 0.001792 0.228302 0.000000 3.515980 0.460267 -12.410666 -0.059647 -8.284450 0.195324 -8.312960 0.000000 0.000000 0.000000 1.000000"],
        ["6.499726 -0.069267 0.002499 0.200054 0.000000 4.901203 0.419355 -10.774202 -0.059647 -7.548073 0.272278 -11.391106 0.000000 0.000000 0.000000 1.000000"],
        ["4.302105 3.827997 0.308638 -12.045526 0.000000 7.411016 -0.283697 17.347885 -4.872565 3.379833 0.272504 -11.400165 0.000000 0.000000 0.000000 1.000000"],
        ["4.302105 4.734542 0.267020 -10.380803 -0.000001 6.411684 -0.350882 20.035282 -4.872565 4.180241 0.235758 -9.930341 0.000000 0.000000 0.000000 1.000000"],
        ["3.592300 1.227213 -0.411088 16.743504 0.000000 8.878719 0.081807 2.727713 5.417138 -0.813809 0.272607 -11.404284 0.000000 0.000000 0.000000 1.000000"],
        ["3.592300 -0.076353 -0.416681 16.967253 -0.000000 8.999534 -0.005090 6.203589 5.417138 0.050633 0.276316 -11.552661 0.000000 0.000000 0.000000 1.000000"],
        ["4.405418 -3.716185 0.304200 -11.868016 -0.000000 7.446907 0.280781 -5.231261 -4.779361 -3.425427 0.280399 -11.715981 0.000000 0.000000 0.000000 1.000000"],
        ["4.405419 -2.708899 0.335429 -13.117176 -0.000001 8.211400 0.204675 -2.186986 -4.779360 -2.496954 0.309185 -12.867406 0.000000 0.000000 0.000000 1.000000"],
        ["6.349392 -1.353294 -0.076148 3.345920 0.000000 6.404414 -0.351292 20.051666 1.391122 6.176737 0.347557 -14.402270 0.000000 0.000000 0.000000 1.000000"],
        ["6.349392 -1.570747 -0.061936 2.777431 0.000000 5.209096 -0.407739 22.309555 1.391121 7.169245 0.282689 -11.807554 0.000000 0.000000 0.000000 1.000000"],
        ["5.611467 3.139803 -0.182346 7.593843 -0.000000 6.503500 0.345627 -7.825098 3.280463 -5.370859 0.311916 -12.976642 0.000000 0.000000 0.000000 1.000000"],
        ["5.611467 2.522150 -0.209866 8.694635 -0.000000 7.485013 0.277637 -5.105463 3.280463 -4.314318 0.358991 -14.859627 0.000000 0.000000 0.000000 1.000000"],
        ["4.724389 0.609635 0.341735 -13.369398 0.000000 8.956122 -0.049312 7.972491 -4.464319 0.645149 0.361643 -14.965714 0.000000 0.000000 0.000000 1.000000"],
        ["4.724389 1.668523 0.330662 -12.926480 -0.000000 8.665925 -0.134964 11.398556 -4.464319 1.765723 0.349925 -14.496994 0.000000 0.000000 0.000000 1.000000"],
        ["5.144022 -1.183077 -0.298507 12.240272 -0.000000 8.789460 -0.107517 10.300671 3.973542 1.531574 0.386437 -15.957498 0.000000 0.000000 0.000000 1.000000"],
        ["5.144021 -2.098138 -0.282559 11.602341 -0.000000 8.319866 -0.190676 13.627053 3.973543 2.716183 0.365791 -15.131652 0.000000 0.000000 0.000000 1.000000"],
        ["6.284044 -1.466055 0.098501 -3.640021 0.000000 6.935977 0.318621 -6.744834 -1.661563 -5.544629 0.372530 -15.401193 0.000000 0.000000 0.000000 1.000000"],
        ["6.284044 -1.135902 0.111147 -4.145891 -0.000000 7.826506 0.246868 -3.874722 -1.661563 -4.295990 0.420360 -17.314398 0.000000 0.000000 0.000000 1.000000"],
        ["6.310709 0.927469 0.108138 -4.025527 -0.000000 8.124821 -0.215075 14.602983 -1.557224 3.758602 0.438234 -18.029364 0.000000 0.000000 0.000000 1.000000"],
        ["6.310709 1.251383 0.097548 -3.601917 0.000000 7.329134 -0.290188 17.607529 -1.557224 5.071276 0.395317 -16.312666 0.000000 0.000000 0.000000 1.000000"],
        ["5.828282 1.154948 -0.211858 8.774317 0.000000 8.613622 0.144930 0.202795 2.877695 -2.339151 0.429082 -17.663288 0.000000 0.000000 0.000000 1.000000"],
        ["5.828282 0.475204 -0.219781 9.091249 0.000000 8.935763 0.059632 3.614733 2.877695 -0.962447 0.445130 -18.305183 0.000000 0.000000 0.000000 1.000000"],
        ["6.010379 -0.694654 0.186428 -7.157109 -0.000000 8.813150 0.101355 1.945809 -2.474943 -1.686962 0.452738 -18.609531 0.000000 0.000000 0.000000 1.000000"],
        ["6.010379 -0.101390 0.190297 -7.311876 0.000000 8.996059 0.014793 5.408261 -2.474943 -0.246224 0.462134 -18.985380 0.000000 0.000000 0.000000 1.000000"],
        ["6.428964 -0.210349 -0.072786 3.211456 -0.000000 8.886198 -0.079262 9.170454 0.958341 1.411116 0.488282 -20.031301 0.000000 0.000000 0.000000 1.000000"],
        ["6.428964 -0.434659 -0.069651 3.086054 -0.000000 8.503452 -0.163783 12.551336 0.958341 2.915882 0.467251 -19.190050 0.000000 0.000000 0.000000 1.000000"],
        ["6.500000 0.000000 0.000000 0.300000 0.000000 8.965753 0.043578 4.256886 0.000000 -0.784401 0.498097 -20.423895 0.000000 0.000000 0.000000 1.000000"],
        ["6.500000 0.000000 0.000000 0.300000 0.000000 8.965753 -0.043578 7.743114 0.000000 0.784402 0.498097 -20.423895 0.000000 0.000000 0.000000 1.000000"],
    ]
    idx = int(sensor.id()[len('elm__') :])
    raw_string = light_positions[int((idx - 1) / 2) * 2 + index][0]
    float_values = list(map(float, raw_string.strip().split()))
    matrix_4x4 = np.array(float_values).reshape((4, 4))
    params['arealight.to_world'] = mi.Transform4f(matrix_4x4)
    params.update()

def save_images(scene, params, dir, spp):
    print("start rendering")
    for i, sensor in enumerate(scene.sensors()):
      for j in range(2):
        #update_light_position(params, sensor, j)
        image = mi.render(scene, sensor=sensor, spp=spp)
        bitmap = mi.Bitmap(image).convert(
            pixel_format=mi.Bitmap.PixelFormat.RGB,
            component_format=mi.Struct.Type.UInt8,
            srgb_gamma=True
        )
        png_path = dir / f"view_{i:02d}_{j:02d}.png"
        bitmap.write(str(png_path))

        bitmap = mi.Bitmap(image).convert(
                pixel_format=mi.Bitmap.PixelFormat.RGB,
                component_format=mi.Struct.Type.Float32,
                srgb_gamma=False
        )
        exr_path = dir / f"view_{i:02d}_{j:02d}.exr"
        bitmap.write(str(exr_path))
        print(f"saving: {i}")
    print(f"Saved: {dir}")

def optimize(scene, params, opt, ref_images, spp):
   for it in range(iteration_count):
    total_loss = 0.0
    for i, sensor in enumerate(scene.sensors()):
        for j in range(2):
            #update_light_position(params, sensor, j)
            img = mi.render(scene, params, sensor=sensor, spp=spp, seed=it)
            loss = dr.mean(dr.sqr(img - ref_images[i*2+j]))
            dr.backward(loss)
            opt.step()
            opt[key1] = dr.clip(opt[key1], 1e-6, 100.0)
            opt[key2] = dr.clip(opt[key2], 1e-6, 100.0)
            params.update(opt)
            total_loss += loss
            print(f"Sensor {i:02d} Light {j}: error={dr.mean(loss)}")
    print(f"Iteration {it:02d}: error={dr.mean(total_loss)}")

ref_spp=4096
opt_spp=128

key1="medium1.sigma_t.data"
key2="medium1.albedo.data"

set_root_path()
sys.path.append('python/')
sys.path = [p for p in sys.path if "unbiased-inverse-volume-rendering" not in p]
print(os.getcwd())
print(sys.executable)
os.environ.pop("PYTHONPATH")

# from practical_reconstruction import scene_configuration
mi.set_variant('cuda_ad_rgb')

# from practical_reconstruction import optimization_cli
# from core import integrators
# from core import bsdfs
# from core import textures
# from practical_reconstruction import scene_preparation

# integrators.register()
# bsdfs.register()
# textures.register()

import numpy as np

ref_scene_path="third_party/kiwi_ours/mts_scene/kiwi_ref.xml"
ref_dir=Path("third_party/kiwi_ours/references")

ref_scene = mi.load_file(ref_scene_path)
ref_params = mi.traverse(ref_scene)
# print(ref_params)
#print(ref_scene)
save_images(ref_scene, ref_params, ref_dir, ref_spp)

init_scene_path="third_party/kiwi_ours/mts_scene/kiwi_init.xml"
init_scene = mi.load_file(init_scene_path)

ref_images=[]
for i, sensor in enumerate(init_scene.sensors()):
    for j in range(2):
        exr_path = ref_dir / f"view_{i:02d}_{j:02d}.exr"
        bmp = mi.Bitmap(str(exr_path))
        tensor = mi.TensorXf(bmp)
        ref_image = mi.Bitmap(tensor)
        ref_images.append(tensor)

params = mi.traverse(init_scene)

opt = mi.ad.Adam(lr=0.02)
opt[key1] = params[key1]
opt[key2] = params[key2]
params.update(opt)
iteration_count = 2
optimize(init_scene, params, opt, ref_images, opt_spp)

opt[key1] = dr.upsample(opt[key1], shape=(74, 60, 64))
opt[key2] = dr.upsample(opt[key2], shape=(34, 18, 18))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)

opt_spp*=2
opt[key1] = dr.upsample(opt[key1], shape=(148, 120, 128))
opt[key2] = dr.upsample(opt[key2], shape=(68, 36, 36))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
sigma_t = opt[key1]
albedo = opt[key2]
grid_sigma_t = mi.VolumeGrid(sigma_t)
grid_sigma_t.write('third_party/kiwi_ours/intermediate/sigma_t.vol')
grid_albedo = mi.VolumeGrid(albedo)
grid_albedo.write('third_party/kiwi_ours/intermediate/albedo.vol')
save_images(init_scene, params, Path("third_party/kiwi_ours/intermediate"), ref_spp)

opt_spp*=2
opt[key1] = dr.upsample(opt[key1], shape=(296, 240, 256))
opt[key2] = dr.upsample(opt[key2], shape=(136, 72, 72))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
sigma_t = opt[key1]
albedo = opt[key2]
grid_sigma_t = mi.VolumeGrid(sigma_t)
grid_sigma_t.write('third_party/kiwi_ours/intermediate2/sigma_t.vol')
grid_albedo = mi.VolumeGrid(albedo)
grid_albedo.write('third_party/kiwi_ours/intermediate2/albedo.vol')
save_images(init_scene, params, Path("third_party/kiwi_ours/intermediate2"), opt_spp)

opt_spp*=2
opt[key1] = dr.upsample(opt[key1], shape=(592, 480, 512))
opt[key2] = dr.upsample(opt[key2], shape=(272, 144, 144))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
sigma_t = opt[key1]
albedo = opt[key2]
grid_sigma_t = mi.VolumeGrid(sigma_t)
grid_sigma_t.write('third_party/kiwi_ours/output/sigma_t.vol')
grid_albedo = mi.VolumeGrid(albedo)
grid_albedo.write('third_party/kiwi_ours/output/albedo.vol')
save_images(init_scene, params, Path("third_party/kiwi_ours/output"), opt_spp)