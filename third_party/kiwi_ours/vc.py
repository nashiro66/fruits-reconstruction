import os
import sys
from pathlib import Path
from pathlib import Path
import mitsuba as mi
import drjit as dr

def set_root_path():
    if os.getcwd().endswith('figures'): 
        os.chdir('../')

def update_light_position(params, sensor, index):
    light_positions = [
        ["-6.500000 0.000001 0.000000 0.300000 0.000001 7.471460 0.043578 4.256886 -0.000001 0.653668 -0.498097 19.423895 0.000000 0.000000 0.000000 1.000000"],
        ["-6.500000 0.000001 -0.000000 0.300000 0.000001 7.471460 -0.043578 7.743114 -0.000000 -0.653669 -0.498097 19.423895 0.000000 0.000000 0.000000 1.000000"],
        ["-6.351649 -0.166873 -0.105630 4.525181 -0.000001 7.458747 -0.052370 8.094799 1.380779 -0.767621 -0.485901 18.936043 0.000000 0.000000 0.000000 1.000000"],
        ["-6.351649 -0.439471 -0.102093 4.383719 0.000001 7.209023 -0.137921 11.516834 1.380779 -2.021595 -0.469633 18.285309 0.000000 0.000000 0.000000 1.000000"],
        ["-6.495393 -0.133494 0.016586 -0.363436 0.000000 6.608728 0.236406 -3.456229 -0.244695 3.543571 -0.440270 17.110783 0.000000 0.000000 0.000000 1.000000"],
        ["-6.495393 -0.088264 0.017879 -0.415173 0.000000 7.124097 0.156308 -0.252319 -0.244695 2.342958 -0.474603 18.484127 0.000000 0.000000 0.000000 1.000000"],
        ["-6.168086 0.706186 0.150544 -5.721768 0.000001 7.158140 -0.149236 11.969419 -2.050541 -2.124225 -0.452841 17.613653 0.000000 0.000000 0.000000 1.000000"],
        ["-6.168086 1.087581 0.140082 -5.303277 -0.000001 6.660676 -0.229835 15.193392 -2.050540 -3.271478 -0.421370 16.354818 0.000000 0.000000 0.000000 1.000000"],
        ["-5.463686 0.738533 -0.266341 10.953645 0.000001 7.375046 0.090889 2.364422 3.521098 1.145980 -0.413281 16.031258 0.000000 0.000000 0.000000 1.000000"],
        ["-5.463686 0.033567 -0.270844 11.133778 0.000000 7.499744 0.004131 5.834756 3.521098 0.052086 -0.420269 16.310770 0.000000 0.000000 0.000000 1.000000"],
        ["-5.470313 -1.645187 0.246786 -9.571454 -0.000000 6.853624 0.203064 -2.122541 -3.510794 2.563433 -0.384528 14.881118 0.000000 0.000000 0.000000 1.000000"],
        ["-5.470313 -0.977382 0.262083 -10.183308 -0.000000 7.278427 0.120637 1.174509 -3.510794 1.522899 -0.408362 15.834473 0.000000 0.000000 0.000000 1.000000"],
        ["-6.340923 -0.928877 -0.090842 3.933682 -0.000001 6.197108 -0.281629 17.265163 1.429231 -4.121048 -0.403030 15.621183 0.000000 0.000000 0.000000 1.000000"],
        ["-6.340923 -1.151383 -0.078709 3.448351 -0.000001 5.369396 -0.349091 19.963663 1.429231 -5.108220 -0.349199 13.467967 0.000000 0.000000 0.000000 1.000000"],
        ["-5.923949 2.120718 -0.149531 6.281228 0.000000 5.449727 0.343514 -7.740579 2.675224 4.696065 -0.331117 12.744678 0.000000 0.000000 0.000000 1.000000"],
        ["-5.923949 1.699015 -0.171810 7.172383 0.000000 6.261693 0.275207 -5.008269 2.675225 3.762254 -0.380451 14.718030 0.000000 0.000000 0.000000 1.000000"],
        ["-4.525468 0.906112 0.353791 -13.851655 0.000001 7.393009 -0.084154 9.366148 -4.665848 -0.878849 -0.343147 13.225879 0.000000 0.000000 0.000000 1.000000"],
        ["-4.525468 1.813874 0.337927 -13.217074 0.000001 7.061496 -0.168461 12.738428 -4.665848 -1.759299 -0.327760 12.610391 0.000000 0.000000 0.000000 1.000000"],
        ["-4.304458 -1.186353 -0.366210 14.948386 -0.000001 7.330979 -0.105551 10.222051 4.870486 -1.048479 -0.323650 12.446008 0.000000 0.000000 0.000000 1.000000"],
        ["-4.304458 -2.122203 -0.346912 14.176490 -0.000000 6.944674 -0.188815 13.552604 4.870486 -1.875569 -0.306595 11.763819 0.000000 0.000000 0.000000 1.000000"],
        ["-5.629382 -2.950367 0.154266 -5.870659 -0.000000 4.628530 0.393428 -9.737112 -3.249624 5.110973 -0.267239 10.189544 0.000000 0.000000 0.000000 1.000000"],
        ["-5.629383 -2.503722 0.186078 -7.143115 0.000001 5.582982 0.333868 -7.354734 -3.249623 4.337245 -0.322346 12.393842 0.000000 0.000000 0.000000 1.000000"],
        ["-5.920269 2.292678 0.138724 -5.248968 -0.000001 5.040547 -0.370242 20.809698 -2.683361 -5.058311 -0.306066 11.742624 0.000000 0.000000 0.000000 1.000000"],
        ["-5.920268 2.619185 0.110075 -4.103014 -0.000001 3.999592 -0.422970 22.918791 -2.683361 -5.778679 -0.242858 9.214321 0.000000 0.000000 0.000000 1.000000"],
        ["-3.675667 3.143757 -0.355149 14.505958 -0.000000 6.459154 0.254116 -4.164632 5.360921 2.155488 -0.243505 9.240179 0.000000 0.000000 0.000000 1.000000"],
        ["-3.675665 2.170932 -0.386147 15.745892 -0.000000 7.022926 0.175480 -1.019221 5.360922 1.488479 -0.264758 10.090327 0.000000 0.000000 0.000000 1.000000"],
        ["-3.107381 -1.807922 0.422301 -16.592033 -0.000000 7.212013 0.137224 0.511019 -5.709132 0.984020 -0.229851 8.694041 0.000000 0.000000 0.000000 1.000000"],
        ["-3.107381 -0.680479 0.436815 -17.172585 -0.000002 7.459878 0.051650 3.934016 -5.709132 0.370370 -0.237751 9.010025 0.000000 0.000000 0.000000 1.000000"],
        ["-4.135763 -3.920634 -0.283677 11.647075 0.000000 5.515674 -0.338804 19.552162 5.014525 -3.233569 -0.233964 8.858571 0.000000 0.000000 0.000000 1.000000"],
        ["-4.135761 -4.599971 -0.233980 9.659192 0.000001 4.549388 -0.397509 21.900372 5.014527 -3.793855 -0.192976 7.219052 0.000000 0.000000 0.000000 1.000000"],
        ["-6.216394 2.072850 -0.047364 2.194574 -0.000000 2.431740 0.472989 -12.919552 1.899062 6.785273 -0.155043 5.701702 0.000000 0.000000 0.000000 1.000000"],
        ["-6.216394 1.917988 -0.070641 3.125649 0.000000 3.626800 0.437652 -11.506077 1.899062 6.278347 -0.231237 8.749484 0.000000 0.000000 0.000000 1.000000"],
        ["-2.830673 3.596400 0.380923 -14.936939 0.000001 6.347353 -0.266342 16.653698 -5.851264 -1.739834 -0.184280 6.871190 0.000000 0.000000 0.000000 1.000000"],
        ["-2.830673 4.533962 0.333502 -13.040101 -0.000001 5.557174 -0.335777 19.431061 -5.851264 -2.193401 -0.161339 5.953554 0.000000 0.000000 0.000000 1.000000"],
        ["-1.991337 0.342002 -0.475412 19.316462 -0.000000 7.491390 0.023952 5.041926 6.187453 0.110068 -0.153004 5.620157 0.000000 0.000000 0.000000 1.000000"],
        ["-1.991337 -0.901509 -0.472148 19.185926 0.000000 7.439966 -0.063136 8.525457 6.187453 -0.290137 -0.151954 5.578147 0.000000 0.000000 0.000000 1.000000"],
        ["-2.352270 -5.183686 0.312785 -12.211402 0.000000 5.032896 0.370705 -8.828190 -6.059441 2.012302 -0.121423 4.356915 0.000000 0.000000 0.000000 1.000000"],
        ["-2.352270 -4.290215 0.368042 -14.421692 0.000001 5.922019 0.306809 -6.272375 -6.059441 1.665458 -0.142874 5.214948 0.000000 0.000000 0.000000 1.000000"],
        ["-6.373148 -1.400425 -0.030760 1.530412 0.000001 2.346954 -0.474889 24.995544 1.277881 -6.984312 -0.153410 5.636408 0.000000 0.000000 0.000000 1.000000"],
        ["-6.373148 -1.459272 -0.014081 0.863236 -0.000001 1.074348 -0.494844 25.793743 1.277881 -7.277795 -0.070225 2.309015 0.000000 0.000000 0.000000 1.000000"],
        ["-1.819812 5.825052 -0.282132 11.585292 0.000001 4.408278 0.404514 -10.180557 6.240055 1.698782 -0.082279 2.791171 0.000000 0.000000 0.000000 1.000000"],
        ["-1.819809 5.001679 -0.345280 14.111202 -0.000000 5.394953 0.347336 -7.893433 6.240056 1.458658 -0.100695 3.527811 0.000000 0.000000 0.000000 1.000000"],
        ["-0.936765 0.334599 0.494277 -19.471090 -0.000001 7.492374 -0.022542 6.901674 -6.432144 -0.048732 -0.071986 2.379426 0.000000 0.000000 0.000000 1.000000"],
        ["-0.936768 1.616971 0.482894 -19.015783 0.000000 7.319832 -0.108935 10.357409 -6.432143 -0.235493 -0.070328 2.313116 0.000000 0.000000 0.000000 1.000000"],
        ["-0.805986 -3.678387 -0.431301 17.552036 -0.000000 6.519830 -0.247133 15.885323 6.449836 -0.459659 -0.053896 1.655852 0.000000 0.000000 0.000000 1.000000"],
        ["-0.805986 -4.745923 -0.382165 15.586620 0.000000 5.777067 -0.318856 18.754227 6.449836 -0.593061 -0.047756 1.410249 0.000000 0.000000 0.000000 1.000000"],
        ["-1.749547 -7.150301 0.068249 -2.429942 0.000000 1.062956 0.494953 -13.798115 -6.260118 1.998331 -0.019074 0.262951 0.000000 0.000000 0.000000 1.000000"],
        ["-1.749547 -6.863903 0.149987 -5.699498 0.000001 2.336023 0.475128 -13.005123 -6.260118 1.918290 -0.041918 1.176710 0.000000 0.000000 0.000000 1.000000"],
        ["-0.266642 6.150860 0.285363 -11.114536 -0.000000 4.284057 -0.410403 22.416113 -6.494529 -0.252533 -0.011716 -0.031361 0.000000 0.000000 0.000000 1.000000"],
        ["-0.266642 6.800707 0.209822 -8.092896 -0.000000 3.149987 -0.453762 24.150499 -6.494529 -0.279213 -0.008615 -0.155419 0.000000 0.000000 0.000000 1.000000"],
        ["0.139237 2.892458 -0.461196 18.747837 0.000000 6.919527 0.192875 -1.714996 6.498508 -0.061974 0.009882 -0.895264 0.000000 0.000000 0.000000 1.000000"],
        ["0.139237 1.647229 -0.487674 19.806959 -0.000000 7.316788 0.109841 1.606380 6.498508 -0.035293 0.010449 -0.917957 0.000000 0.000000 0.000000 1.000000"],
        ["0.438206 -3.712985 0.433118 -17.024734 0.000001 6.511590 0.248097 -3.923871 -6.485212 -0.250886 0.029266 -1.670635 0.000000 0.000000 0.000000 1.000000"],
        ["0.438206 -2.528424 0.469522 -18.480875 0.000001 7.058887 0.168946 -0.757837 -6.485212 -0.170845 0.031726 -1.769026 0.000000 0.000000 0.000000 1.000000"],
        ["1.669134 -6.375299 -0.229941 9.497636 0.000000 3.568785 -0.439766 23.590660 6.282037 1.693913 0.061095 -2.943807 0.000000 0.000000 0.000000 1.000000"],
        ["1.669133 -6.877377 -0.152644 6.405746 -0.000001 2.369096 -0.474400 24.975986 6.282038 1.827315 0.040557 -2.122293 0.000000 0.000000 0.000000 1.000000"],
        ["2.549824 6.619631 -0.129521 5.480829 -0.000001 2.112105 0.479764 -13.190556 5.978996 -2.823031 0.055236 -2.709435 0.000000 0.000000 0.000000 1.000000"],
        ["2.549825 6.181697 -0.204185 8.467418 -0.000000 3.329669 0.448024 -11.920975 5.978996 -2.636270 0.087078 -3.983106 0.000000 0.000000 0.000000 1.000000"],
        ["1.342485 2.774372 0.452909 -17.816345 0.000000 6.943335 -0.189034 13.561356 -6.359853 0.585635 0.095603 -4.324132 0.000000 0.000000 0.000000 1.000000"],
        ["1.342485 3.911925 0.413910 -16.256413 -0.000000 6.345469 -0.266542 16.661674 -6.359853 0.825758 0.087371 -3.994850 0.000000 0.000000 0.000000 1.000000"],
        ["1.506390 -1.189326 -0.479881 19.495253 0.000001 7.399677 -0.081507 9.260298 6.323036 0.283342 0.114326 -5.073051 0.000000 0.000000 0.000000 1.000000"],
        ["1.506392 -2.421215 -0.458823 18.652903 0.000001 7.074955 -0.165932 12.637274 6.323036 0.576826 0.109309 -4.872371 0.000000 0.000000 0.000000 1.000000"],
        ["2.947506 -5.741310 0.228237 -8.829502 0.000000 3.841195 0.429445 -11.177811 -5.793290 -2.921059 0.116123 -5.144900 0.000000 0.000000 0.000000 1.000000"],
        ["2.947505 -5.059591 0.291235 -11.349385 -0.000001 4.901424 0.378453 -9.138130 -5.793291 -2.574214 0.148174 -6.426963 0.000000 0.000000 0.000000 1.000000"],
        ["5.750979 3.161509 0.099370 -3.674804 0.000000 3.198365 -0.452256 24.090235 -3.029231 6.002110 0.188654 -8.046147 0.000000 0.000000 0.000000 1.000000"],
        ["5.750979 3.372309 0.061261 -2.150444 -0.000001 1.971775 -0.482411 25.296446 -3.029230 6.402315 0.116304 -5.152157 0.000000 0.000000 0.000000 1.000000"],
        ["2.754609 4.371011 -0.346680 14.167196 0.000000 5.741240 0.321719 -6.868753 5.887455 -2.045099 0.162204 -6.988153 0.000000 0.000000 0.000000 1.000000"],
        ["2.754609 3.401601 -0.392014 15.980571 -0.000001 6.492005 0.250367 -4.014700 5.887455 -1.591532 0.183415 -7.836591 0.000000 0.000000 0.000000 1.000000"],
        ["2.527739 -1.124330 0.454504 -17.880175 0.000001 7.400044 0.081359 2.745625 -5.988367 -0.474588 0.191850 -8.174003 0.000000 0.000000 0.000000 1.000000"],
        ["2.527740 0.076609 0.460615 -18.124611 0.000001 7.499539 -0.005544 6.221743 -5.988366 0.032338 0.194430 -8.277182 0.000000 0.000000 0.000000 1.000000"],
        ["3.722162 -3.661347 -0.329304 13.472149 -0.000000 6.025268 -0.297741 17.909624 5.328743 2.557475 0.230021 -9.700837 0.000000 0.000000 0.000000 1.000000"],
        ["3.722163 -4.463467 -0.281915 11.576605 -0.000001 5.158199 -0.362969 20.518763 5.328743 3.117763 0.196920 -8.376787 0.000000 0.000000 0.000000 1.000000"],
        ["6.499726 -0.063354 0.001792 0.228302 0.000000 2.929983 0.460267 -12.410666 -0.059647 -6.903708 0.195324 -8.312960 0.000000 0.000000 0.000000 1.000000"],
        ["6.499726 -0.057723 0.002499 0.200054 0.000000 4.084336 0.419355 -10.774202 -0.059647 -6.290061 0.272278 -11.391106 0.000000 0.000000 0.000000 1.000000"],
        ["4.302105 3.189998 0.308638 -12.045526 0.000000 6.175847 -0.283697 17.347885 -4.872565 2.816527 0.272504 -11.400165 0.000000 0.000000 0.000000 1.000000"],
        ["4.302105 3.945452 0.267020 -10.380803 -0.000001 5.343070 -0.350882 20.035282 -4.872565 3.483534 0.235758 -9.930341 0.000000 0.000000 0.000000 1.000000"],
        ["3.592300 1.022677 -0.411088 16.743504 0.000000 7.398933 0.081807 2.727713 5.417138 -0.678174 0.272607 -11.404284 0.000000 0.000000 0.000000 1.000000"],
        ["3.592300 -0.063627 -0.416681 16.967253 -0.000000 7.499611 -0.005090 6.203589 5.417138 0.042194 0.276316 -11.552661 0.000000 0.000000 0.000000 1.000000"],
        ["4.405418 -3.096821 0.304200 -11.868016 -0.000000 6.205755 0.280781 -5.231261 -4.779361 -2.854522 0.280399 -11.715981 0.000000 0.000000 0.000000 1.000000"],
        ["4.405419 -2.257416 0.335429 -13.117176 -0.000001 6.842834 0.204675 -2.186986 -4.779360 -2.080795 0.309185 -12.867406 0.000000 0.000000 0.000000 1.000000"],
        ["6.349392 -1.127745 -0.076148 3.345920 0.000000 5.337012 -0.351292 20.051666 1.391122 5.147281 0.347557 -14.402270 0.000000 0.000000 0.000000 1.000000"],
        ["6.349392 -1.308956 -0.061936 2.777431 0.000000 4.340913 -0.407739 22.309555 1.391121 5.974370 0.282689 -11.807554 0.000000 0.000000 0.000000 1.000000"],
        ["5.611467 2.616503 -0.182346 7.593843 -0.000000 5.419583 0.345627 -7.825098 3.280463 -4.475716 0.311916 -12.976642 0.000000 0.000000 0.000000 1.000000"],
        ["5.611467 2.101792 -0.209866 8.694635 -0.000000 6.237511 0.277637 -5.105463 3.280463 -3.595265 0.358991 -14.859627 0.000000 0.000000 0.000000 1.000000"],
        ["4.724389 0.508029 0.341735 -13.369398 0.000000 7.463435 -0.049312 7.972491 -4.464319 0.537624 0.361643 -14.965714 0.000000 0.000000 0.000000 1.000000"],
        ["4.724389 1.390436 0.330662 -12.926480 -0.000000 7.221604 -0.134964 11.398556 -4.464319 1.471436 0.349925 -14.496994 0.000000 0.000000 0.000000 1.000000"],
        ["5.144022 -0.985898 -0.298507 12.240272 -0.000000 7.324550 -0.107517 10.300671 3.973542 1.276312 0.386437 -15.957498 0.000000 0.000000 0.000000 1.000000"],
        ["5.144021 -1.748448 -0.282559 11.602341 -0.000000 6.933221 -0.190676 13.627053 3.973543 2.263486 0.365791 -15.131652 0.000000 0.000000 0.000000 1.000000"],
        ["6.284044 -1.221712 0.098501 -3.640021 0.000000 5.779980 0.318621 -6.744834 -1.661563 -4.620524 0.372530 -15.401193 0.000000 0.000000 0.000000 1.000000"],
        ["6.284044 -0.946585 0.111147 -4.145891 -0.000000 6.522089 0.246868 -3.874722 -1.661563 -3.579992 0.420360 -17.314398 0.000000 0.000000 0.000000 1.000000"],
        ["6.310709 0.772891 0.108138 -4.025527 -0.000000 6.770684 -0.215075 14.602983 -1.557224 3.132169 0.438234 -18.029364 0.000000 0.000000 0.000000 1.000000"],
        ["6.310709 1.042819 0.097548 -3.601917 0.000000 6.107612 -0.290188 17.607529 -1.557224 4.226064 0.395317 -16.312666 0.000000 0.000000 0.000000 1.000000"],
        ["5.828282 0.962457 -0.211858 8.774317 0.000000 7.178018 0.144930 0.202795 2.877695 -1.949292 0.429082 -17.663288 0.000000 0.000000 0.000000 1.000000"],
        ["5.828282 0.396004 -0.219781 9.091249 0.000000 7.446470 0.059632 3.614733 2.877695 -0.802039 0.445130 -18.305183 0.000000 0.000000 0.000000 1.000000"],
        ["6.010379 -0.578878 0.186428 -7.157109 -0.000000 7.344292 0.101355 1.945809 -2.474943 -1.405802 0.452738 -18.609531 0.000000 0.000000 0.000000 1.000000"],
        ["6.010379 -0.084492 0.190297 -7.311876 0.000000 7.496716 0.014793 5.408261 -2.474943 -0.205187 0.462134 -18.985380 0.000000 0.000000 0.000000 1.000000"],
        ["6.428964 -0.175291 -0.072786 3.211456 -0.000000 7.405165 -0.079262 9.170454 0.958341 1.175930 0.488282 -20.031301 0.000000 0.000000 0.000000 1.000000"],
        ["6.428964 -0.362216 -0.069651 3.086054 -0.000000 7.086210 -0.163783 12.551336 0.958341 2.429902 0.467251 -19.190050 0.000000 0.000000 0.000000 1.000000"],
        ["6.500000 0.000000 0.000000 0.300000 0.000000 7.471460 0.043578 4.256886 0.000000 -0.653668 0.498097 -20.423895 0.000000 0.000000 0.000000 1.000000"],
        ["6.500000 0.000000 0.000000 0.300000 0.000000 7.471460 -0.043578 7.743114 0.000000 0.653668 0.498097 -20.423895 0.000000 0.000000 0.000000 1.000000"],
    ]
    idx = int(sensor.id()[len('elm__') :])
    raw_string = light_positions[int((idx - 1) / 2) * 2 + index][0]
    float_values = list(map(float, raw_string.strip().split()))
    matrix_4x4 = np.array(float_values).reshape((4, 4))
    params['arealight.to_world'] = mi.Transform4f(matrix_4x4)
    # if index==1:
    #    params['arealight.emitter.radiance.value'] = mi.Color3f([5.000000, 5.000000, 5.000000])
    # else:
    #    params['arealight.emitter.radiance.value'] = mi.Color3f([5.000000, 5.000000, 5.000000])
    #params['arealight.emitter.radiance.data'] *= 1.0
    params.update()

def save_images(scene, params, dir, spp):
    print("start rendering")
    for i, sensor in enumerate(scene.sensors()):
      for j in range(2):
        update_light_position(params, sensor, j)
        image = mi.render(scene, sensor=sensor, spp=spp)
        bitmap = mi.Bitmap(image).convert(
            pixel_format=mi.Bitmap.PixelFormat.RGB,
            component_format=mi.Struct.Type.UInt8,
            srgb_gamma=True
        )
        png_path = dir / f"view_{i:02d}_{j:02d}.png"
        bitmap.write(str(png_path))

        bitmap = mi.Bitmap(image).convert(
                pixel_format=mi.Bitmap.PixelFormat.RGB,
                component_format=mi.Struct.Type.Float32,
                srgb_gamma=False
        )
        exr_path = dir / f"view_{i:02d}_{j:02d}.exr"
        bitmap.write(str(exr_path))
        print(f"saving: {i}")
    print(f"Saved: {dir}")

def optimize(scene, params, opt, ref_images, spp):
   for it in range(iteration_count):
    total_loss = 0.0
    for i, sensor in enumerate(scene.sensors()):
        for j in range(2):
            update_light_position(params, sensor, j)
            img = mi.render(scene, params, sensor=sensor, spp=spp, seed=it)
            loss = dr.mean(dr.sqr(img - ref_images[i*2+j]))
            dr.backward(loss)
            opt.step()
            opt[key1] = dr.clip(opt[key1], 1e-6, 100.0)
            # opt[key2] = dr.clip(opt[key2], 1e-6, 100.0)
            params.update(opt)
            total_loss += loss
            print(f"Sensor {i:02d} Light {j}: error={dr.mean(loss)}")
    print(f"Iteration {it:02d}: error={dr.mean(total_loss)}")

ref_spp=4096
opt_spp=128

key1="medium1.sigma_t.data"

set_root_path()
sys.path.append('python/')
sys.path = [p for p in sys.path if "unbiased-inverse-volume-rendering" not in p]
print(os.getcwd())
print(sys.executable)
os.environ.pop("PYTHONPATH")

# from practical_reconstruction import scene_configuration
mi.set_variant('cuda_ad_rgb')

# from practical_reconstruction import optimization_cli
# from core import integrators
# from core import bsdfs
# from core import textures
# from practical_reconstruction import scene_preparation

# integrators.register()
# bsdfs.register()
# textures.register()

import numpy as np

ref_scene_path="third_party/kiwi_ours/mts_scene/vc_ref.xml"
ref_dir=Path("third_party/kiwi_ours/references")

ref_scene = mi.load_file(ref_scene_path)
ref_params = mi.traverse(ref_scene)
print(ref_params)
#print(ref_scene)
save_images(ref_scene, ref_params, ref_dir, ref_spp)

init_scene_path="third_party/kiwi_ours/mts_scene/vc_init.xml"
init_scene = mi.load_file(init_scene_path)

ref_images=[]
for i, sensor in enumerate(init_scene.sensors()):
    for j in range(2):
        exr_path = ref_dir / f"view_{i:02d}_{j:02d}.exr"
        bmp = mi.Bitmap(str(exr_path))
        tensor = mi.TensorXf(bmp)
        ref_image = mi.Bitmap(tensor)
        ref_images.append(tensor)

params = mi.traverse(init_scene)

opt = mi.ad.Adam(lr=0.02)
opt[key1] = params[key1]
params.update(opt)
iteration_count = 3

optimize(init_scene, params, opt, ref_images, opt_spp)
# initial : 17, 9, 9
opt[key1] = dr.upsample(opt[key1], shape=(34, 18, 18))
params.update(opt)

optimize(init_scene, params, opt, ref_images, opt_spp)

opt[key1] = dr.upsample(opt[key1], shape=(68, 36, 36))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)

opt_spp*=2
opt[key1] = dr.upsample(opt[key1], shape=(136, 72, 72))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
sigma_t = opt[key1]
grid_sigma_t = mi.VolumeGrid(sigma_t)
grid_sigma_t.write('third_party/kiwi_ours/intermediate/sigma_t.vol')
save_images(init_scene, params, Path("third_party/kiwi_ours/intermediate"), ref_spp)

opt_spp*=2
print(opt_spp)
opt[key1] = dr.upsample(opt[key1], shape=(272, 144, 144))
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
sigma_t = opt[key1]
grid_sigma_t = mi.VolumeGrid(sigma_t)
grid_sigma_t.write('third_party/kiwi_ours/intermediate2/sigma_t.vol')
save_images(init_scene, params, Path("third_party/kiwi_ours/intermediate2"), opt_spp)

opt_spp*=2
print(opt_spp)
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
save_images(init_scene, params, Path("third_party/kiwi_ours/intermediate3"), opt_spp)

opt_spp*=2
print(opt_spp)
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
save_images(init_scene, params, Path("third_party/kiwi_ours/intermediate4"), opt_spp)

opt_spp*=2
print(opt_spp)
params.update(opt)
optimize(init_scene, params, opt, ref_images, opt_spp)
sigma_t = opt[key1]
grid_sigma_t = mi.VolumeGrid(sigma_t)
grid_sigma_t.write('third_party/kiwi_ours/output/sigma_t.vol')
save_images(init_scene, params, Path("third_party/kiwi_ours/output"), opt_spp)